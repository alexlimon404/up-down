# Up-Down - Загрузчик файлов из PostgreSQL

Приложение для массового скачивания файлов из базы данных PostgreSQL с организацией по citizenship_id и логированием статуса в отдельной БД.

## Возможности

**Загрузчик (main.go):**
- Параллельная загрузка файлов (настраиваемое количество воркеров)
- Поддержка Uploadcare CDN
- Организация файлов по структуре: `downloads/{citizenship_id}/user_{id}/`
- Логирование статуса скачивания в отдельную БД с использованием GORM
- Автоматическая миграция таблиц
- Отображение прогресса в реальном времени
- Пропуск уже скачанных файлов

**Веб-интерфейс (web.go):**
- Просмотр статуса скачанных файлов в таблице
- Пагинация (20 записей на странице)
- Отображение ссылок на файлы из Uploadcare
- Статус document/address (true/false) с цветовыми индикаторами
- Кнопка скачивания для просмотра пути к файлам
- Множественный выбор пользователей
- Bootstrap дизайн

## Установка

```bash
# Клонируйте репозиторий
git clone <repo-url>
cd up-down

# Установите зависимости
go mod download
```

## Настройка

1. Скопируйте `.env.example` в `.env`:
```bash
cp .env.example .env
```

2. Отредактируйте `.env` под свои параметры:
```env
# Основная БД (источник данных)
DB_HOST=localhost
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=your_password
DB_NAME=solar_prod_03_07_2025

# Вторая БД (для логирования статуса)
DB2_HOST=localhost
DB2_PORT=5432
DB2_USER=postgres
DB2_PASSWORD=your_password
DB2_NAME=up_down

# Настройки скачивания
DOWNLOAD_DIR=./downloads
BATCH_SIZE=100
WORKERS=5
```

3. Создайте базу данных для логирования (если не существует):
```bash
psql -U postgres -c "CREATE DATABASE \"up_down\";"
```

## Использование

### Запуск миграций (опционально)

Миграции выполняются автоматически при запуске основного приложения, но можно запустить отдельно:

```bash
go run migrate.go
```

### Запуск приложения

```bash
go run main.go
# или
make run
```

Приложение запустит веб-интерфейс по адресу: **http://localhost:8080**

**Что происходит при запуске:**
1. Подключается к обеим базам данных
2. Выполняет автоматическую миграцию таблицы `user_files`
3. Запускает веб-сервер
4. Ожидает команды пользователя через веб-интерфейс

**Как использовать:**
1. Откройте браузер и перейдите на http://localhost:8080
2. Нажмите кнопку **"Запустить скачивание"**
3. Наблюдайте за прогрессом в реальном времени
4. Просматривайте результаты в таблице

**Возможности веб-интерфейса:**

*Панель управления скачиванием:*
- Кнопка "Запустить скачивание" - начинает процесс
- Кнопка "Остановить скачивание" - останавливает процесс
- Прогресс-бар с процентом выполнения
- Статистика в реальном времени:
  - Обработано пользователей
  - Успешно скачано
  - Количество файлов
  - Время выполнения

*Таблица пользователей:*
- Просмотр статуса скачанных файлов
- Пагинация (20 записей на странице)
- Ссылки на файлы Uploadcare (document_files, address_files)
- Цветовые индикаторы статуса (зелёный = скачано, серый = не скачано)
- Кнопка для просмотра пути к файлам
- Множественный выбор пользователей

### Структура скачанных файлов

```
downloads/
├── RU/                          # citizenship_id
│   ├── user_12345/
│   │   ├── documents/
│   │   │   ├── document_1.jpg
│   │   │   └── document_2.jpg
│   │   └── address/
│   │       └── address_1.pdf
│   └── user_67890/
│       └── ...
└── US/
    └── ...
```

### Таблица user_files

После скачивания в БД `up-down` будет таблица со статусом:

```sql
SELECT * FROM user_files;
```

| id | user_id | document | address | created_at | updated_at |
|----|---------|----------|---------|------------|------------|
| 1  | 12345   | true     | true    | ...        | ...        |
| 2  | 67890   | true     | false   | ...        | ...        |

## Структура проекта

```
up-down/
├── config/              # Конфигурация
├── database/            # Подключения к БД
├── models/              # Модели данных
├── repositories/        # Репозитории для работы с БД
├── services/            # Бизнес-логика (загрузчик)
├── main.go             # Точка входа
├── migrate.go          # Скрипт миграции
└── .env               # Переменные окружения
```

## Технологии

- Go 1.x
- PostgreSQL
- GORM (ORM)
- lib/pq (PostgreSQL драйвер)
- godotenv (загрузка .env)

## Параметры .env

| Параметр | Описание | По умолчанию |
|----------|----------|--------------|
| DB_NAME | Основная БД (источник) | solar_prod_03_07_2025 |
| DB2_NAME | БД для логирования | up-down |
| DOWNLOAD_DIR | Директория для файлов | ./downloads |
| BATCH_SIZE | Размер пакета запросов | 100 |
| WORKERS | Количество параллельных воркеров | 5 |

## Логи

Приложение выводит:
- Прогресс скачивания каждые 2 секунды
- Ошибки скачивания/записи
- Финальную статистику

## Производительность

- ~100,000 пользователей с файлами
- 5 параллельных воркеров
- Автоматический пропуск существующих файлов
- Пул соединений: 25 max open, 5 idle

## Лицензия

MIT
